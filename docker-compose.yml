# docker-compose.yml (Modulare Version mit n8n)
#
# Services:
# - lobechat-adapter:   Port 8100 → LobeChat trägt diese URL ein
# - mcp-sql-memory:     Port 8082 → Memory-Server
# - validator-service:  Port 8300 → Validator
# - n8n:                Port 5678 → Workflow Automation
# - container-manager:  Port 8400 → Container MCP-Server
#
# Netzwerk: big-bear-lobe-chat_default (extern, muss existieren)

services:
  # ============================================================
  # LOBECHAT ADAPTER
  # ============================================================
  lobechat-adapter:
    build:
      context: .
      dockerfile: adapters/lobechat/Dockerfile
    container_name: lobechat-adapter
    ports:
      - "8100:8100"
    environment:
      # Service URLs
      - OLLAMA_BASE=http://ollama:11434
      - MCP_BASE=http://mcp-sql-memory:8081/mcp
      - VALIDATOR_URL=http://validator-service:8000
      - N8N_WEBHOOK_URL=http://n8n:5678/webhook
      - CONTAINER_MANAGER_URL=http://container-manager:8400
      
      # Model Konfiguration
      - THINKING_MODEL=deepseek-r1:8b
      - CONTROL_MODEL=qwen3:4b
      - OUTPUT_MODEL=llama3.1:8b
      - CODE_MODEL=qwen2.5-coder:3b
      - EMBEDDING_MODEL=hellord/mxbai-embed-large-v1:f16
      
      # Layer Toggles
      - ENABLE_CONTROL_LAYER=true
      - SKIP_CONTROL_ON_LOW_RISK=true
      
      # Validation
      - ENABLE_VALIDATION=true
      - VALIDATION_HARD_FAIL=true
      - LOG_LEVEL=INFO
    volumes:
      - ./config:/app/config:ro
    networks:
      - big-bear-lobe-chat_default
    restart: unless-stopped
    depends_on:
      - mcp-sql-memory
      - container-manager

  # ============================================================
  # MCP SQL MEMORY SERVER
  # ============================================================
  mcp-sql-memory:
    build:
      context: ../sql-memory
    container_name: mcp-sql-memory
    environment:
      - DB_PATH=/app/data/memory.db
      - OLLAMA_URL=http://ollama:11434
      - EMBEDDING_MODEL=hellord/mxbai-embed-large-v1:f16
    volumes:
      - ../sql-memory/data:/app/data
    ports:
      - "8082:8081"
    networks:
      - big-bear-lobe-chat_default
    restart: unless-stopped

  # ============================================================
  # VALIDATOR SERVICE
  # ============================================================
  validator-service:
    build:
      context: ../validator-service/validator-service
    container_name: validator-service
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
      - EMBEDDING_MODEL=hellord/mxbai-embed-large-v1:f16
      - VALIDATOR_MODEL=qwen2.5:0.5b-instruct
    ports:
      - "8300:8000"
    networks:
      - big-bear-lobe-chat_default
    restart: unless-stopped

  # ============================================================
  # N8N - WORKFLOW AUTOMATION
  # ============================================================
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://n8n:5678
      - GENERIC_TIMEZONE=Europe/Berlin
      # Sicherheit: Nur interne Webhooks erlauben
      - N8N_ENDPOINT_WEBHOOK=webhook
      - N8N_ENDPOINT_WEBHOOK_TEST=webhook-test
    volumes:
      - ./n8n/data:/home/node/.n8n
      # Docker Socket für Container-Management!
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - big-bear-lobe-chat_default
    restart: unless-stopped
    # n8n braucht root für Docker-Socket
    user: root

  # ============================================================
  # CONTAINER MANAGER - MCP Server für Sandbox-Container
  # ============================================================
  container-manager:
    build:
      context: ./container-manager
    container_name: container-manager
    ports:
      - "8400:8400"
    environment:
      - N8N_WEBHOOK_URL=http://n8n:5678/webhook
      - REGISTRY_PATH=/app/containers/registry.yaml
    volumes:
      # Container-Registry (read-only)
      - ./containers:/app/containers:ro
      # Docker Socket für direkte Container-Operationen
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - big-bear-lobe-chat_default
    restart: unless-stopped
    depends_on:
      - n8n

networks:
  big-bear-lobe-chat_default:
    external: true

