<!DOCTYPE html>
<html>
<head>
    <title>TRION Connection Test</title>
    <style>
        body { font-family: monospace; background: #111; color: #0f0; padding: 20px; }
        .box { background: #222; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { color: #0f0; }
        .error { color: #f00; }
        .info { color: #0af; }
        button { background: #333; color: #fff; border: 1px solid #555; padding: 10px 20px; cursor: pointer; margin: 5px; }
        button:hover { background: #444; }
        #log { height: 300px; overflow-y: auto; background: #000; padding: 10px; }
    </style>
</head>
<body>
    <h1>ğŸ”Œ TRION Connection Test</h1>
    
    <div class="box">
        <h3>Status</h3>
        <div id="status">Initializing...</div>
    </div>
    
    <div class="box">
        <h3>Actions</h3>
        <button onclick="testPing()">ğŸ“ Send Ping</button>
        <button onclick="listPlugins()">ğŸ“¦ List Plugins</button>
        <button onclick="enablePingTest()">âœ… Enable Ping Test</button>
        <button onclick="clearLog()">ğŸ—‘ï¸ Clear Log</button>
    </div>
    
    <div class="box">
        <h3>Log</h3>
        <div id="log"></div>
    </div>

    <script>
        const log = (msg, type = 'info') => {
            const el = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            el.innerHTML += '<div class="' + type + '">[' + time + '] ' + msg + '</div>';
            el.scrollTop = el.scrollHeight;
        };
        
        const setStatus = (msg, ok) => {
            document.getElementById('status').innerHTML = 
                '<span class="' + (ok ? 'success' : 'error') + '">' + msg + '</span>';
        };
        
        const clearLog = () => document.getElementById('log').innerHTML = '';
        
        // Connect to TRION
        let ws;
        let pendingRequests = new Map();
        
        function connect() {
            log('Connecting to ws://localhost:8400/trion/...');
            ws = new WebSocket('ws://' + location.host + '/trion/');
            
            ws.onopen = () => {
                log('âœ… Connected to TRION!', 'success');
                setStatus('Connected', true);
            };
            
            ws.onclose = () => {
                log('âŒ Disconnected', 'error');
                setStatus('Disconnected', false);
                setTimeout(connect, 3000);
            };
            
            ws.onerror = (e) => {
                log('âŒ WebSocket Error', 'error');
            };
            
            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                log('ğŸ“¥ Received: ' + JSON.stringify(msg).substring(0, 200));
                
                if (msg.direction === 'response' && pendingRequests.has(msg.id)) {
                    pendingRequests.get(msg.id)(msg);
                    pendingRequests.delete(msg.id);
                }
                
                if (msg.type === 'pong') {
                    log('ğŸ“ PONG received: ' + msg.payload?.message, 'success');
                }
            };
        }
        
        function sendRequest(type, payload = {}) {
            return new Promise((resolve) => {
                const id = Math.random().toString(36).substring(2);
                pendingRequests.set(id, resolve);
                const msg = { id, direction: 'request', type, payload, timestamp: Date.now() };
                log('ğŸ“¤ Sending: ' + JSON.stringify(msg));
                ws.send(JSON.stringify(msg));
            });
        }
        
        async function listPlugins() {
            const resp = await sendRequest('plugin:list');
            if (resp.success) {
                log('ğŸ“¦ Plugins: ' + resp.data.map(p => p.manifest?.name || p.id).join(', '), 'success');
            }
        }
        
        async function enablePingTest() {
            const resp = await sendRequest('plugin:enable', { id: 'ping-test' });
            log(resp.success ? 'âœ… Ping Test enabled!' : 'âŒ Failed to enable', resp.success ? 'success' : 'error');
        }
        
        async function testPing() {
            log('ğŸ“ Sending ping via backend:event...');
            await sendRequest('backend:event', { eventType: 'ping', data: { test: true, time: Date.now() } });
        }
        
        connect();
    </script>
</body>
</html>
